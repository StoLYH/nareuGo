<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.nareugobackend.mapper.ChatMapper">

    <!-- 메시지 저장 -->
    <insert id="insertMessage" parameterType="org.example.nareugobackend.api.controller.chat.request.ChatMessage">
        INSERT INTO chat_messages (room_id, sender_id, receiver_id, content, timestamp)
        VALUES (#{roomId}, #{senderId}, #{receiverId}, #{content}, #{timestamp})
    </insert>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom" parameterType="org.example.nareugobackend.api.controller.chat.request.ChatRoom"
            useGeneratedKeys="true" keyProperty="roomId">
        INSERT INTO chat_rooms (user1_id, user2_id, product_id, created_at, last_message_at)
        VALUES (#{user1Id}, #{user2Id}, #{productId}, #{createdAt}, #{createdAt})
    </insert>

    <!-- 채팅방 찾기 (두 사용자 간) -->
    <select id="findChatRoom" resultType="org.example.nareugobackend.api.controller.chat.request.ChatRoom">
        SELECT room_id, user1_id, user2_id, product_id, created_at, last_message_at, last_message
        FROM chat_rooms
        WHERE (user1_id = #{user1Id} AND user2_id = #{user2Id})
           OR (user1_id = #{user2Id} AND user2_id = #{user1Id})
        LIMIT 1
    </select>

    <!-- 채팅방의 메시지 목록 조회 -->
    <select id="findMessagesByRoomId" resultType="org.example.nareugobackend.api.controller.chat.request.ChatMessage">
        SELECT room_id, sender_id, receiver_id, content, timestamp
        FROM chat_messages
        WHERE room_id = #{roomId}
        ORDER BY timestamp ASC
    </select>

    <!-- 사용자의 채팅방 목록 조회 -->
    <select id="findChatRoomsByUserId" resultType="org.example.nareugobackend.api.controller.chat.request.ChatRoom">
        SELECT room_id, user1_id, user2_id, product_id, created_at, last_message_at, last_message
        FROM chat_rooms
        WHERE user1_id = #{userId} OR user2_id = #{userId}
        ORDER BY last_message_at DESC
    </select>

    <!-- 채팅방 최근 메시지 업데이트 -->
    <update id="updateRoomLastMessage">
        UPDATE chat_rooms
        SET last_message = #{lastMessage},
            last_message_at = #{lastMessageAt}
        WHERE room_id = #{roomId}
    </update>

</mapper>
