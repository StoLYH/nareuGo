# ====================================================================
# í”„ë¡ íŠ¸ì—”ë“œ CI/CD íŒŒì´í”„ë¼ì¸
# ====================================================================

# 1. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¡(Job)
build-frontend:
  stage: build
  image: node:20
  tags:
    - ec2-runner
  script:
    - echo "====== [Frontend] Vue í”„ë¡œì íŠ¸ ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ======"
    - cd FrontEnd
    # âœ… GitLab ë³€ìˆ˜ë¡œë¶€í„° .env.production ìƒì„±
    - echo "VITE_BASE_URL=$VITE_BASE_URL" > .env.production
    - echo "VITE_TOSS_CLIENT_KEY=$VITE_TOSS_CLIENT_KEY" >> .env.production
    - echo "VITE_KAKAO_MAP_API_KEY=$VITE_KAKAO_MAP_API_KEY" >> .env.production
    - npm install
    - npm run build
    - echo "====== [Frontend] ë¹Œë“œ ê²°ê³¼ë¬¼(dist)ì„ artifactsë¡œ ì €ì¥í•©ë‹ˆë‹¤. ======"
    # âœ… ë””ë²„ê¹…ìš©: ìƒì„±ëœ .env.production íŒŒì¼ í™•ì¸
    - echo "====== [Frontend] ìµœì¢… .env.production ë‚´ìš© ======"
    - cat .env.production
  artifacts:
    paths:
      - FrontEnd/dist/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - FrontEnd/**/*

# 2. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì¡(Job)
deploy-frontend:
  stage: deploy
  image: alpine:3.19   # ğŸ‘ˆ latest ëŒ€ì‹  ì•ˆì •ëœ ë²„ì „ ì‚¬ìš©
  tags:
    - ec2-runner
  dependencies:
    - build-frontend # build-frontend ì¡ì˜ ê²°ê³¼ë¬¼(artifacts)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  before_script:
    - echo "====== [Deploy-FE] ë°°í¬ í™˜ê²½ì„ ì¤€ë¹„í•©ë‹ˆë‹¤. (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° SSH ì„¤ì •) ======"
    - apk update && apk add openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$EC2_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $LIVE_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "====== [Deploy-FE] í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë°°í¬ ì‹œì‘ ======"
    - rsync -avz --delete ./FrontEnd/dist/ ubuntu@$LIVE_SERVER_IP:/var/www/html/
    - echo "âœ… [Deploy-FE] í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë°°í¬ ì™„ë£Œ"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - FrontEnd/**/*
